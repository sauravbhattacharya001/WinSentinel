name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  CONFIGURATION: Release
  PLATFORM: x64

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Code quality: format & style checks
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Code Style & Format
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore
      run: dotnet restore

    - name: Check formatting
      run: dotnet format --verify-no-changes --verbosity diagnostic
      continue-on-error: true

    - name: Check style violations
      run: dotnet format style --verify-no-changes --verbosity diagnostic
      continue-on-error: true

    - name: Check analyzer warnings
      run: dotnet format analyzers --verify-no-changes --severity warn --verbosity diagnostic
      continue-on-error: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build & Test with coverage
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-test:
    name: Build & Test (${{ matrix.configuration }})
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        configuration: [ Debug, Release ]

    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Cache NuGet packages
      uses: actions/cache@v5
      with:
        path: ~/.nuget/packages
        key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
        restore-keys: nuget-${{ runner.os }}-

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: >-
        dotnet build --no-restore
        --configuration ${{ matrix.configuration }}
        -p:Platform=x64
        -p:TreatWarningsAsErrors=true
        -p:EnforceCodeStyleInBuild=true

    - name: Test with coverage
      run: >-
        dotnet test --no-build
        --configuration ${{ matrix.configuration }}
        -p:Platform=x64
        --verbosity normal
        --logger "trx;LogFileName=test-results.trx"
        --collect:"XPlat Code Coverage"
        --results-directory TestResults
      continue-on-error: true

    - name: Upload test results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: test-results-${{ matrix.configuration }}
        path: '**/TestResults/**/*.trx'
        retention-days: 14

    - name: Upload coverage
      uses: actions/upload-artifact@v6
      if: always() && matrix.configuration == 'Release'
      with:
        name: coverage-report
        path: '**/TestResults/**/coverage.cobertura.xml'
        retention-days: 14

    - name: Upload to Codecov
      if: matrix.configuration == 'Release'
      uses: codecov/codecov-action@v4
      with:
        files: '**/TestResults/**/coverage.cobertura.xml'
        flags: unittests
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Generate coverage report summary
      if: matrix.configuration == 'Release'
      shell: pwsh
      run: |
        $coverageFiles = Get-ChildItem -Recurse -Filter "coverage.cobertura.xml" -Path TestResults
        if ($coverageFiles.Count -gt 0) {
          $xml = [xml](Get-Content $coverageFiles[0].FullName)
          $lineRate = [math]::Round([double]$xml.coverage.'line-rate' * 100, 1)
          $branchRate = [math]::Round([double]$xml.coverage.'branch-rate' * 100, 1)
          $linesValid = $xml.coverage.'lines-valid'
          $linesCovered = $xml.coverage.'lines-covered'

          Write-Output "## ðŸ“Š Code Coverage Summary" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "| Metric | Value |" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "|--------|-------|" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "| Line Coverage | **$lineRate%** |" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "| Branch Coverage | **$branchRate%** |" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "| Lines Covered | $linesCovered / $linesValid |" >> $env:GITHUB_STEP_SUMMARY
        }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Security: check for vulnerable packages
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security:
    name: Security Audit
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore
      run: dotnet restore

    - name: Check for vulnerable NuGet packages
      run: dotnet list package --vulnerable --include-transitive
      continue-on-error: true

    - name: Check for deprecated packages
      run: dotnet list package --deprecated
      continue-on-error: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Publish artifacts (Release only)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish:
    name: Publish Artifacts
    runs-on: windows-latest
    needs: [ build-and-test, lint ]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore
      run: dotnet restore

    - name: Publish CLI
      run: >-
        dotnet publish src/WinSentinel.Cli/WinSentinel.Cli.csproj
        --configuration Release
        -p:Platform=x64
        --output ./artifacts/cli

    - name: Publish Agent
      run: >-
        dotnet publish src/WinSentinel.Agent/WinSentinel.Agent.csproj
        --configuration Release
        -p:Platform=x64
        --output ./artifacts/agent

    - name: Upload CLI artifact
      uses: actions/upload-artifact@v6
      with:
        name: winsentinel-cli
        path: ./artifacts/cli/
        retention-days: 30

    - name: Upload Agent artifact
      uses: actions/upload-artifact@v6
      with:
        name: winsentinel-agent
        path: ./artifacts/agent/
        retention-days: 30
