<Page x:Class="WinSentinel.App.Views.DashboardPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="clr-namespace:WinSentinel.App.Controls"
      Background="{StaticResource AppBackground}">

    <Page.Resources>
        <local:BoolToVisibilityConverter x:Key="BoolToVis" />
        <local:BoolToVisibilityConverter x:Key="BoolToVisInv" Invert="True" />
    </Page.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="32" MaxWidth="1100">

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION 1: Agent Vitals
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Grid Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Agent Status (left) -->
                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="ðŸ›¡ï¸ " FontSize="32" VerticalAlignment="Center" />
                        <TextBlock Text="WinSentinel Agent" FontSize="28" FontWeight="Bold" 
                                  Foreground="{StaticResource TextPrimary}" VerticalAlignment="Center" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                        <TextBlock x:Name="AgentStatusIconText" Text="âšª" FontSize="16" VerticalAlignment="Center" />
                        <TextBlock x:Name="AgentStatusLabel" Text="Unknown" FontSize="16" FontWeight="SemiBold"
                                  Foreground="{StaticResource TextPrimary}" Margin="6,0,0,0" VerticalAlignment="Center" />
                        <TextBlock Text=" Â· " Foreground="{StaticResource TextSecondary}" FontSize="16" VerticalAlignment="Center" />
                        <TextBlock x:Name="UptimeLabel" Text="â€”" FontSize="14"
                                  Foreground="{StaticResource TextSecondary}" VerticalAlignment="Center" />
                    </StackPanel>
                </StackPanel>

                <!-- Quick Actions (right) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button x:Name="RunAuditButton" Content="ðŸ” Run Full Audit" 
                            Style="{StaticResource AccentButton}" Click="RunAuditButton_Click"
                            MinWidth="140" Margin="0,0,8,0" />
                    <Button x:Name="PauseResumeButton" Content="â¸ Pause All" 
                            Style="{StaticResource QuickButton}" Click="PauseResumeButton_Click"
                            MinWidth="120" Margin="0,0,8,0" />
                    <Button Content="ðŸ“„ Export Report" 
                            Style="{StaticResource QuickButton}" Click="ExportButton_Click"
                            MinWidth="120" Margin="0,0,8,0" />
                    <Button Content="ðŸ’¬ Open Chat" 
                            Style="{StaticResource QuickButton}" Click="OpenChatButton_Click"
                            MinWidth="110" />
                </StackPanel>
            </Grid>

            <!-- Disconnected Banner -->
            <Border x:Name="DisconnectedBanner" Background="#33F44336" CornerRadius="8" 
                    Padding="16,10" Margin="0,0,0,16" Visibility="Visible">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="ðŸ”´ Agent is not connected. Showing last known state." 
                              Foreground="#FFCCCC" VerticalAlignment="Center" FontSize="14" />
                    <Button Grid.Column="1" Content="ðŸ”Œ Reconnect" 
                            Style="{StaticResource AccentButton}" Click="ReconnectButton_Click"
                            Padding="14,6" FontSize="13" />
                </Grid>
            </Border>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION 2: Score + Monitor Cards Grid
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Grid Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="280" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Security Score Card -->
                <Border Grid.Column="0" Background="{StaticResource CardBackground}" CornerRadius="12" 
                        Padding="24" BorderBrush="{StaticResource CardBorder}" BorderThickness="1" Margin="0,0,16,0">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock Text="Security Score" FontSize="15" FontWeight="SemiBold"
                                  Foreground="{StaticResource TextSecondary}" HorizontalAlignment="Center" />
                        
                        <!-- Score Circle -->
                        <Grid Margin="0,12,0,8" Width="140" Height="140">
                            <Ellipse Stroke="#333355" StrokeThickness="6" Fill="Transparent" />
                            <Ellipse x:Name="ScoreRing" Stroke="#4CAF50" StrokeThickness="6" Fill="Transparent"
                                    StrokeDashArray="8 2" />
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                <TextBlock x:Name="ScoreText" Text="â€”" FontSize="48" FontWeight="Bold"
                                          Foreground="{StaticResource TextPrimary}" HorizontalAlignment="Center" />
                                <TextBlock x:Name="GradeText" Text="" FontSize="20" FontWeight="SemiBold"
                                          HorizontalAlignment="Center" Foreground="{StaticResource TextSecondary}" />
                            </StackPanel>
                        </Grid>

                        <!-- Trend Arrow -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,4,0,0">
                            <TextBlock x:Name="TrendArrowText" Text="" FontSize="16" FontWeight="Bold" 
                                      Foreground="#888888" VerticalAlignment="Center" />
                            <TextBlock x:Name="TrendDescText" Text="" FontSize="13" 
                                      Foreground="#888888" Margin="4,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Monitor Status Cards Grid -->
                <Border Grid.Column="1" Background="{StaticResource CardBackground}" CornerRadius="12" 
                        Padding="20" BorderBrush="{StaticResource CardBorder}" BorderThickness="1">
                    <StackPanel>
                        <TextBlock Text="Active Monitors" FontSize="16" FontWeight="SemiBold" 
                                  Foreground="{StaticResource TextPrimary}" Margin="0,0,0,12" />
                        <ItemsControl x:Name="MonitorCardsList">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid Columns="2" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="4" CornerRadius="8" Padding="14" 
                                            Background="#0AFFFFFF" Cursor="Hand">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="BorderThickness" Value="1.5" />
                                                <Setter Property="BorderBrush" Value="#333355" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Status}" Value="Active">
                                                        <Setter Property="BorderBrush" Value="#4CAF50" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Status}" Value="Paused">
                                                        <Setter Property="BorderBrush" Value="#FFC107" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Status}" Value="Error">
                                                        <Setter Property="BorderBrush" Value="#F44336" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>
                                            <StackPanel Grid.Row="0" Orientation="Horizontal">
                                                <TextBlock Text="{Binding Icon}" FontSize="16" VerticalAlignment="Center" />
                                                <TextBlock Text="{Binding DisplayName}" FontSize="14" FontWeight="SemiBold"
                                                          Foreground="{StaticResource TextPrimary}" Margin="6,0,0,0" 
                                                          VerticalAlignment="Center" />
                                            </StackPanel>
                                            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,6,0,0">
                                                <TextBlock FontSize="12" Foreground="{StaticResource TextSecondary}">
                                                    <Run Text="Status: " />
                                                    <Run Text="{Binding Status, Mode=OneWay}" FontWeight="SemiBold" />
                                                </TextBlock>
                                            </StackPanel>
                                            <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,4,0,0">
                                                <TextBlock FontSize="12" Foreground="{StaticResource TextSecondary}">
                                                    <Run Text="{Binding EventsDetected, Mode=OneWay}" FontWeight="SemiBold" />
                                                    <Run Text=" events" />
                                                    <Run Text=" Â· Last: " />
                                                    <Run Text="{Binding LastEventTime, Mode=OneWay}" />
                                                </TextBlock>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Placeholder when no monitors -->
                        <TextBlock x:Name="NoMonitorsText" 
                                  Text="No active monitors. Connect the agent to see live data."
                                  Foreground="{StaticResource TextSecondary}" FontStyle="Italic" 
                                  FontSize="13" HorizontalAlignment="Center" Margin="0,20,0,20"
                                  Visibility="Visible" />
                    </StackPanel>
                </Border>
            </Grid>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION 3: Threat Summary + Actions Taken
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Grid Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="320" />
                </Grid.ColumnDefinitions>

                <!-- Threat Summary (left) -->
                <Border Grid.Column="0" Background="{StaticResource CardBackground}" CornerRadius="12" 
                        Padding="20" BorderBrush="{StaticResource CardBorder}" BorderThickness="1" Margin="0,0,16,0">
                    <StackPanel>
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="âš¡ Threat Summary (24h)" FontSize="16" FontWeight="SemiBold" 
                                      Foreground="{StaticResource TextPrimary}" />
                            <Button Grid.Column="1" Content="View All â†’" 
                                    Style="{StaticResource QuickButton}" Click="ViewAllThreats_Click"
                                    Padding="10,4" FontSize="12" />
                        </Grid>

                        <!-- Severity Breakdown -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                            <Border Background="#22F44336" CornerRadius="6" Padding="10,6" Margin="0,0,8,0">
                                <TextBlock Foreground="#F44336" FontSize="13" FontWeight="SemiBold">
                                    <Run Text="ðŸ”´ Critical " />
                                    <Run x:Name="CritCountText" Text="0" />
                                </TextBlock>
                            </Border>
                            <Border Background="#22FF9800" CornerRadius="6" Padding="10,6" Margin="0,0,8,0">
                                <TextBlock Foreground="#FF9800" FontSize="13" FontWeight="SemiBold">
                                    <Run Text="ðŸŸ  High " />
                                    <Run x:Name="HighCountText" Text="0" />
                                </TextBlock>
                            </Border>
                            <Border Background="#22FFC107" CornerRadius="6" Padding="10,6" Margin="0,0,8,0">
                                <TextBlock Foreground="#FFC107" FontSize="13" FontWeight="SemiBold">
                                    <Run Text="ðŸŸ¡ Medium " />
                                    <Run x:Name="MedCountText" Text="0" />
                                </TextBlock>
                            </Border>
                            <Border Background="#222196F3" CornerRadius="6" Padding="10,6">
                                <TextBlock Foreground="#2196F3" FontSize="13" FontWeight="SemiBold">
                                    <Run Text="ðŸ”µ Low " />
                                    <Run x:Name="LowCountText" Text="0" />
                                </TextBlock>
                            </Border>
                        </StackPanel>

                        <!-- Mini Threat Feed -->
                        <ItemsControl x:Name="RecentThreatsList">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#08FFFFFF" CornerRadius="4" Padding="10,6" Margin="0,0,0,4">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="40" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding Time}" 
                                                      FontSize="12" Foreground="{StaticResource TextSecondary}" 
                                                      VerticalAlignment="Center" FontFamily="Cascadia Mono,Consolas" />
                                            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding SeverityIcon}" FontSize="12" 
                                                          VerticalAlignment="Center" Margin="0,0,6,0" />
                                                <TextBlock Text="{Binding Title}" FontSize="13" 
                                                          Foreground="{StaticResource TextPrimary}" 
                                                          TextTrimming="CharacterEllipsis" VerticalAlignment="Center" />
                                            </StackPanel>
                                            <TextBlock Grid.Column="2" Text="{Binding Source}" 
                                                      FontSize="11" Foreground="{StaticResource TextSecondary}" 
                                                      VerticalAlignment="Center" Margin="8,0,0,0" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <TextBlock x:Name="NoThreatsText" 
                                  Text="No threats detected in the last 24 hours âœ…"
                                  Foreground="{StaticResource TextSecondary}" FontStyle="Italic" 
                                  FontSize="13" HorizontalAlignment="Center" Margin="0,12,0,4"
                                  Visibility="Visible" />
                    </StackPanel>
                </Border>

                <!-- Actions Taken (right) -->
                <Border Grid.Column="1" Background="{StaticResource CardBackground}" CornerRadius="12" 
                        Padding="20" BorderBrush="{StaticResource CardBorder}" BorderThickness="1">
                    <StackPanel>
                        <TextBlock Text="ðŸ”§ Actions Taken" FontSize="16" FontWeight="SemiBold" 
                                  Foreground="{StaticResource TextPrimary}" Margin="0,0,0,12" />
                        
                        <!-- Auto-fixes count -->
                        <Border Background="#0AFFFFFF" CornerRadius="8" Padding="16" Margin="0,0,0,12">
                            <StackPanel>
                                <TextBlock FontSize="14" Foreground="{StaticResource TextSecondary}">
                                    <Run Text="Auto-fixes today:" />
                                </TextBlock>
                                <TextBlock x:Name="AutoFixCountText" Text="0" FontSize="36" FontWeight="Bold"
                                          Foreground="#4CAF50" Margin="0,4,0,0" />
                            </StackPanel>
                        </Border>

                        <!-- Last Action -->
                        <TextBlock Text="Last action:" FontSize="13" 
                                  Foreground="{StaticResource TextSecondary}" Margin="0,0,0,4" />
                        <TextBlock x:Name="LastActionLabel" 
                                  Text="No actions taken yet" FontSize="13"
                                  Foreground="{StaticResource TextPrimary}" TextWrapping="Wrap"
                                  Margin="0,0,0,12" />
                    </StackPanel>
                </Border>
            </Grid>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECTION 4: Agent Timeline
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Border Background="{StaticResource CardBackground}" CornerRadius="12" 
                    Padding="20" BorderBrush="{StaticResource CardBorder}" BorderThickness="1"
                    Margin="0,0,0,16">
                <StackPanel>
                    <TextBlock Text="ðŸ“œ Agent Timeline â€” Today" FontSize="16" FontWeight="SemiBold" 
                              Foreground="{StaticResource TextPrimary}" Margin="0,0,0,12" />

                    <ItemsControl x:Name="TimelineList" MaxHeight="400">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="55" />
                                        <ColumnDefinition Width="30" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBlock Grid.Column="0" Text="{Binding Time}" 
                                              FontSize="13" FontFamily="Cascadia Mono,Consolas"
                                              Foreground="{StaticResource TextSecondary}" 
                                              VerticalAlignment="Center" HorizontalAlignment="Right"
                                              Margin="0,0,8,0" />

                                    <!-- Timeline dot connector -->
                                    <Grid Grid.Column="1" HorizontalAlignment="Center">
                                        <Ellipse Width="8" Height="8" VerticalAlignment="Center">
                                            <Ellipse.Style>
                                                <Style TargetType="Ellipse">
                                                    <Setter Property="Fill" Value="#AAAACC" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding EntryType}" Value="Critical">
                                                            <Setter Property="Fill" Value="#F44336" />
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding EntryType}" Value="High">
                                                            <Setter Property="Fill" Value="#FF9800" />
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding EntryType}" Value="Warning">
                                                            <Setter Property="Fill" Value="#FFC107" />
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding EntryType}" Value="Action">
                                                            <Setter Property="Fill" Value="#4CAF50" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Ellipse.Style>
                                        </Ellipse>
                                    </Grid>

                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="8,3,0,3">
                                        <TextBlock Text="{Binding Icon}" FontSize="13" 
                                                  VerticalAlignment="Center" Margin="0,0,6,0" />
                                        <TextBlock Text="{Binding Description}" FontSize="13" 
                                                  Foreground="{StaticResource TextPrimary}" 
                                                  TextWrapping="Wrap" VerticalAlignment="Center" />
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <TextBlock x:Name="NoTimelineText"
                              Text="No agent activity recorded today."
                              Foreground="{StaticResource TextSecondary}" FontStyle="Italic"
                              FontSize="13" HorizontalAlignment="Center" Margin="0,12,0,4"
                              Visibility="Visible" />
                </StackPanel>
            </Border>

            <!-- Scan Progress (shown when audit is running) -->
            <Border x:Name="ScanProgressPanel" Background="{StaticResource CardBackground}" CornerRadius="12" 
                    Padding="20" BorderBrush="{StaticResource AccentBrush}" BorderThickness="1"
                    Margin="0,0,0,16" Visibility="Collapsed">
                <StackPanel>
                    <TextBlock Text="ðŸ” Audit Running..." FontSize="16" FontWeight="SemiBold" 
                              Foreground="{StaticResource TextPrimary}" Margin="0,0,0,8" />
                    <ProgressBar IsIndeterminate="True" Height="3" 
                                Foreground="{StaticResource AccentBrush}" />
                </StackPanel>
            </Border>

        </StackPanel>
    </ScrollViewer>
</Page>
